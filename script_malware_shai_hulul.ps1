# Variables : URLs GitHub et chemin du zip temporaire
# REAL MALWARE - DONT SHARE
# Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Unrestricted
$urls = @(
"https://github.com/vers-des-sables/demo-trellix/raw/refs/heads/main/a.zip",
"https://github.com/vers-des-sables/demo-trellix/raw/refs/heads/main/b.zip",
"https://github.com/vers-des-sables/demo-trellix/raw/refs/heads/main/c.zip"
)

$tempFolder = "C:\Temp\work"
$outFolder  = "C:\Temp"
$password   = "infected"
$finalZip   = "C:\Temp\final.zip"


# Chemin de 7-Zip (adapter selon ton installation)
$zipPath = "C:\Program Files\7-Zip\7z.exe"

# Création du dossier temporaire
if (!(Test-Path $tempFolder)) {
    New-Item -ItemType Directory -Path $tempFolder | Out-Null
}

# Téléchargement des fichiers
foreach ($url in $urls) {
    $fileName = Split-Path $url -Leaf
    $destFile = Join-Path $tempFolder $fileName
    Write-Host "Téléchargement de $url vers $destFile"
    Invoke-WebRequest -Uri $url -OutFile $destFile
}

# Décompression de tous les ZIP avec mot de passe
foreach ($zipFile in Get-ChildItem $tempFolder -Filter *.zip) {
    Write-Host "Décompression de $zipFile"
    & "$zipPath" x $zipFile.FullName "-p$password" "-o$outFolder" -y
}

# Recréation d'une nouvelle archive ZIP depuis C:\Temp
if (Test-Path $finalZip) {
    Remove-Item $finalZip -Force
}
Write-Host "Création du nouvel archive $finalZip"
& "$zipPath" a $finalZip "$outFolder\*"

Write-Host "Traitement terminé ! Le fichier final est $finalZip"
